steps:
  - name: 'gcr.io/cloud-builders/docker'
    args:
    - 'build'
    - '-f'
    - 'backend/Dockerfile'
    - '-t'
    - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY_ID}/backend:${SHORT_SHA}'
    - './backend'
  - name: 'gcr.io/cloud-builders/docker'
    args:
    - push
    - ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY_ID}/backend:${SHORT_SHA}
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args:
    - 'run'
    - 'deploy'
    - 'backend'
    - '--image'
    - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY_ID}/backend:${SHORT_SHA}'
    - '--region'
    - '${_REGION}'
    - '--set-env-vars'
    - 'MYSQL_USER=$$MYSQL_USER'
    - '--set-env-vars'
    - 'MYSQL_PASSWORD=$$MYSQL_PASSWORD'
    - '--set-env-vars'
    - 'MYSQL_HOST=${_MYSQL_HOST}'
    - '--set-env-vars'
    - 'MYSQL_PORT=3306'
    - '--set-env-vars'
    - 'MYSQL_DATABASE=${_MYSQL_DATABASE}'
    - '--vpc-connector=${_VPC_CONNECTOR}'
    secretEnv: ['MYSQL_USER', 'MYSQL_PASSWORD']
  - name: 'gcr.io/cloud-builders/curl'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      curl -L https://github.com/golang-migrate/migrate/releases/download/v4.15.1/migrate.linux-amd64.tar.gz | tar xvz
      ./migrate -database "${_CLOUD_SQL_URL}" -path ./backend/migrations up

availableSecrets:
  secretManager:
  - versionName: ${_MYSQL_USER_ID}
    env: MYSQL_USER
  - versionName: ${_MYSQL_PASSWORD_ID}
    env: MYSQL_PASSWORD

logsBucket: 'gs://${_LOG_BUCKET}'

options:
  logging: 'GCS_ONLY'
  pool:
    name: '${_POOL_NAME}'

images:
 - '${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPOSITORY_ID}/backend:${SHORT_SHA}'
